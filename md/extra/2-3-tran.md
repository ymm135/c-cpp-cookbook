- # 二三层转发实例讲解

[华为-二三层转发实例讲解](https://support.huawei.com/enterprise/zh/knowledge/EKB1001157897)  

## 环境搭建

[GNS3环境搭建](https://github.com/ymm135/docs/blob/master/network/network-learn.md) 


拓扑图:


pc1配置
```sh
ip 192.168.200.2 24 192.168.1.1

PC1> show ip

NAME        : PC1[1]
IP/MASK     : 192.168.200.2/24
GATEWAY     : 192.168.1.1
DNS         : 
MAC         : 00:50:79:66:68:00
LPORT       : 20028
RHOST:PORT  : 127.0.0.1:20029
MTU         : 1500
```

pc2配置
```sh
ip 192.168.200.2 24 192.168.200.1
```

pc3配置
```sh
ip 192.168.200.3 24 192.168.200.1
```


R1配置
在使用路由器前，需要计算`Idle-PC`的值, 减少性能消耗

> 在计算机系统上运行的每个程序或任务都会占用 CPU 一定的处理时间。如果 CPU 已完成所有任务，则它处于空闲状态。

```sh

```

ESW1(交换机)配置
```sh

```

## ARP报文  


请求`10.25.16.170`的mac地址:  
```sh
Frame 33: 60 bytes on wire (480 bits), 60 bytes captured (480 bits) on interface en1, id 0
Ethernet II, Src: Tp-LinkT_91:a4:8d (a4:1a:3a:91:a4:8d), Dst: Broadcast (ff:ff:ff:ff:ff:ff)
    Destination: Broadcast (ff:ff:ff:ff:ff:ff)
    Source: Tp-LinkT_91:a4:8d (a4:1a:3a:91:a4:8d)
    Type: ARP (0x0806)
    Padding: 000000000000000000000000000000000000
Address Resolution Protocol (request)
    Hardware type: Ethernet (1)
    Protocol type: IPv4 (0x0800)
    Hardware size: 6
    Protocol size: 4
    Opcode: request (1)
    Sender MAC address: Tp-LinkT_91:a4:8d (a4:1a:3a:91:a4:8d)
    Sender IP address: 10.25.16.5
    Target MAC address: 00:00:00_00:00:00 (00:00:00:00:00:00)
    Target IP address: 10.25.16.170
```

- ### 对于二层转发(PC2 Ping PC3)

1. PC2生成一个源IP地址为`192.168.200.2/24`，目的IP地址为`192.168.200.3/24`的ICMP请求报文。

2. PC2的IP地址为`192.168.200.2/24`，PC3的IP地址为`192.168.200.3/24`，通过IP地址与掩码相与可以知道两台PC的网段均为`192.168.1.0/24`。在同一个网段，那么进行二层转发。

3. `PC2`在广播域中发出ARP请求报文，请求`PC3`的MAC地址。

4. 交换机收到来自`PC2`的`ARP`请求，首先将`端口`和对应的`MAC`地址记录，然后向各个端口转发ARP请求。

5. 对于到`R4`的`ARP`请求，`R4`接收到后发现请求的并不是自己的`MAC`地址，丢弃收到的`ARP`报文。

6. 对于发送到`PC3`的`ARP`请求，`PC3`收到后发现请求的是自己的`MAC`地址，则回复自己的`MAC`地址。

7. 交换机收到来自`PC3`的`ARP`回复，首先将端口和对应的`MAC`地址记录，然后将回复报文转发给`PC2`。

8. `PC2`知道了`PC3`的`MAC`地址，则将`PC2`的`MAC`地址和`PC3`的MAC地址加入新的`以太帧`，然后将报文发出。

9. 交换机收到报文查表后将`ICMP`请求报文发给`PC3`。

10. `PC3`收到报文后生成一个源IP地址为`192.168.200.3/24`，目的IP地址为`192.168.200.2/24`的`ICMP`回显报文。

11. PC3的IP地址为`192.168.200.3/24`，PC2的IP地址为`192.168.200.2/24`，通过IP地址与掩码相与可以知道两台PC的网段均为`192.168.1.0/24`。由于在同一个网段，那么进行二层转发。

12. `PC3`向广播域中发送`ARP`请求，请求`PC2`的`MAC`地址。

13. 交换机收到`ARP`请求后将ARP请求报文转发给`PC2`。

14. `PC2`收到请求自己`MAC`地址的`ARP`报文后则途经交换机到达`PC3`。

15. `PC3`知道了`PC2`的`MAC`地址，则将`PC3`的`MAC`地址和`PC2`的MAC地址加入新的以太网帧，然后将报文发出。

16. 交换机收到报文查表后将`ICMP`回显报文发给`PC2`。

17. `PC2`收到了来自`PC3`的`ICMP`回显报文，则`Ping`通。

 
- ### 对于三层转发(PC1 Ping PC3)

1. PC1生成一个源IP地址为 `192.168.1.2/24`，目的IP地址为 `192.168.200.3/24` 的ICMP请求报文。

2. PC1的IP地址为`192.168.1.2/24`，PC3的IP地址为`192.168.200.3/24`，通过IP地址与掩码相与可以知道PC1所在网段为`1192.168.1.0/24`，PC3所在网段为`192.168.1.0/24`。由于不在同一个网段，需要路由器进行转发。PC1的网关为`192.168.1.1`，`PC1`会发送`ARP`请求报文请求网关`R1`的`MAC`地址。

3. `R1`收到`ARP`请求后发现是请求自己的`MAC`地址，则回复自己的`MAC`地址。

4. `PC1`收到后将`ICMP`报文加上自己的`MAC`地址和`R1`的`MAC`地址，发送到`R1`。

5. `R1`收到报文后发现是自己的`MAC`地址，则拆开以太帧头，发现目的IP是`192.168.200.3/24`，则根据查自己的`路由表`，发现有到目的IP的路由，则保留报文，并发出ARP请求，请求`R2`的`MAC`地址。

6. `R2`收到`ARP`请求后发现是请求自己的`MAC`地址，则回复自己的`MAC`地址。

7. R1在收到R2回复的MAC地址后将报文加上自己的MAC地址和R2的MAC地址后从对应端口发出。

8. R2收到报文后发现是自己的MAC地址，则拆开以太帧头，发现目的IP是192.168.200.3/24，则根据查自己的路由表，发现有到目的IP的路由，则保留报文，并发出ARP请求，请求R3的MAC地址。

9. R3收到ARP请求后发现是请求自己的MAC地址，则回复自己的MAC地址。

10. R2在收到R3回复的MAC地址后将报文加上自己的MAC地址和R3的MAC地址后从对应端口发出。

11. R3收到报文后发现是自己的MAC地址，则拆开以太帧头，发现目的IP是192.168.200.3/24，则根据查自己的路由表，发现有到目的IP的路由，则保留报文，并发出ARP请求，请求R4的MAC地址。

12. R4收到ARP请求后发现是请求自己的MAC地址，则回复自己的MAC地址。

13. R3在收到R4回复的MAC地址后将报文加上自己的MAC地址和R3的MAC地址后从对应端口发出。

14. R4收到报文后发现是自己的MAC地址，则拆开以太帧头，发现目的IP是192.168.200.3/24，而自己有一条192.168.1.0/24的直连路由，判断后发现为同一网段，则准备进行二层转发。

15. R4在广播域中发送ARP请求，请求获取PC3的MAC地址。

16. 交换机收到来自R4的ARP请求，首先将端口和对应的MAC地址记录，然后向各个端口转发ARP请求。

17. 对于到PC2的ARP请求，PC2接收到后发现请求的并不是自己的MAC地址，丢弃收到的ARP报文。

18. 对于发送到PC3的ARP请求，PC3收到后发现请求的是自己的MAC地址，则回复自己的MAC地址。

19. 交换机收到来自PC3的ARP回复，首先将端口和对应的MAC地址记录，然后将回复报文转发给R4。

20. R4知道了PC3的MAC地址，则将自己的MAC地址和PC3的MAC地址加入新的以太网帧，然后将报文途经交换机发送给PC3。

21. PC3收到报文后生成一个源IP地址为192.168.200.3/24，目的IP地址为192.168.1.2/24的ICMP回显报文。

22. PC1的IP地址为192.168.1.2/24，PC3的IP地址为192.168.200.3/24，通过IP地址与掩码相与可以知道PC1所在网段为1192.168.1.0/24，PC3所在网段为192.168.1.0/24。由于不在同一个网段，那么进行三层转发。

23. 由于不在同一个网段，需要路由器进行转发。PC3会发送ARP请求报文请求网关R4的MAC地址。

24. 交换机收到PC3发来的ARP请求时先将端口和对应的MAC地址记录，然后进行转发。

25. 对于到PC2的ARP请求，PC2接收到后发现请求的并不是自己的MAC地址，丢弃收到的ARP报文。

26. 对于到R4的ARP请求，R4接收到后发现请求的是自己的MAC地址，则回复自己的MAC地址。

27. PC3知道了R4的MAC地址，则将ICMP回显报文加上自己的MAC地址和R4的MAC地址后途经交换机发送给R4。

28. R4收到报文发现MAC地址是自己的MAC地址，则拆开以太帧。R4发现报文的目的IP为192.168.1.2/24，查路由表后发现有到目的IP的路由，则保留报文，并发出ARP请求，请求R3的MAC地址。

29. R3收到ARP请求后发现是请求自己的MAC地址，则回复自己的MAC地址。

30. R4在收到R3回复的MAC地址后将报文加上自己的MAC地址和R4的MAC地址后从对应端口发出。

31.R3收到报文发现MAC地址是自己的MAC地址，则拆开以太帧。R3发现报文的目的IP为192.168.1.2/24，查路由表后发现有到目的IP的路由，则保留报文，并发出ARP请求，请求R2的MAC地址。

32. R2收到ARP请求后发现是请求自己的MAC地址，则回复自己的MAC地址。

33. R3在收到R2回复的MAC地址后将报文加上自己的MAC地址和R3的MAC地址后从对应端口发出。

34. R2收到报文发现MAC地址是自己的MAC地址，则拆开以太帧。R2发现报文的目的IP为192.168.1.2/24，查路由表后发现有到目的IP的路由，则保留报文，并发出ARP请求，请求R1的MAC地址。

35. R1收到ARP请求后发现是请求自己的MAC地址，则回复自己的MAC地址。

36. R2在收到R1回复的MAC地址后将报文加上自己的MAC地址和R2的MAC地址后从对应端口发出。

37. R1收到报文后发现是自己的MAC地址，则拆开以太帧头，发现目的IP是192.168.1.2/24，而自己有一条1192.168.1.0/24的直连路由，判断后发现为同一网段，则准备进行二层转发。

38. R1在广播域中发送ARP请求，请求获取PC1的MAC地址。

39. PC1收到ARP请求后回复自己的MAC地址。

40. R1在收到PC1回复的MAC地址后将报文加上自己的MAC地址和R1的MAC地址后从对应端口发出。

41. PC1收到PC3的ICMP回显报文，则Ping通。



## 二层转发

## 三层转发

